# Basic Monitoring Tools: Prometheus and Grafana (Overview)

Monitoring is a critical aspect of the DevOps lifecycle, providing insights into the health and performance of applications and infrastructure. Without effective monitoring, it's impossible to proactively identify and resolve issues, optimize performance, or ensure a positive user experience. This lesson introduces two popular open-source monitoring tools: Prometheus and Grafana. We'll explore their core functionalities, architectures, and how they work together to provide comprehensive monitoring capabilities. This will lay the foundation for implementing continuous deployment and ensuring the reliability of our ExampleCorp project.

## Introduction to Prometheus

Prometheus is a powerful open-source monitoring solution that excels at collecting and processing time-series data. It's particularly well-suited for dynamic environments, such as those using containerization and microservices.

### Core Concepts of Prometheus

* **Time-Series Data**: Prometheus fundamentally works with time-series data, which is data indexed by time. Each data point is a timestamped value representing a metric. For example, CPU utilization, memory usage, request latency, and error rates are all examples of metrics that can be tracked as time series.
* **Metrics and Labels**: Metrics are the names of the things you are measuring (e.g., `http_requests_total`). Labels are key-value pairs that provide additional dimensions to the metric, allowing you to filter and aggregate data (e.g., `http_requests_total{method="GET", endpoint="/api/users"}`).
* **Exporters**: Prometheus doesn't directly discover and monitor every application. Instead, it relies on exporters. Exporters are small applications that collect metrics from various sources (e.g., databases, web servers, operating systems) and expose them in a format that Prometheus can understand.
* **PromQL (Prometheus Query Language)**: PromQL is a functional query language that allows you to select and aggregate time-series data. It provides a rich set of functions for performing calculations, filtering data, and generating alerts.
* **Pull-Based Model**: Prometheus uses a pull-based model, meaning it actively scrapes metrics from configured targets (exporters or applications). This is in contrast to push-based systems where applications push metrics to a central server.
* **Service Discovery**: Prometheus can automatically discover targets to monitor using service discovery mechanisms like Kubernetes service discovery, Consul, or DNS. This simplifies the configuration process in dynamic environments.

### Prometheus Architecture

The Prometheus architecture consists of several key components:

* **Prometheus Server**: The core component responsible for scraping, storing, and querying time-series data.
* **Exporters**: Applications that expose metrics in a Prometheus-readable format. Examples include:

  * `node_exporter`: Collects system-level metrics from Linux/Unix systems (CPU, memory, disk, network).
  * `blackbox_exporter`: Probes endpoints over HTTP, HTTPS, DNS, TCP, and ICMP to monitor availability.
  * `mysqld_exporter`: Collects metrics from MySQL databases.
  * `jmx_exporter`: Collects metrics from Java applications via JMX.
* **Alertmanager**: Handles alerts generated by Prometheus based on predefined rules. It can deduplicate, group, and route alerts to various receivers (e.g., email, Slack, PagerDuty).
* **Pushgateway (Optional)**: Allows short-lived jobs to push metrics to Prometheus. This is useful for batch jobs that may not be running when Prometheus scrapes.

### Example: Monitoring CPU Usage with Prometheus

Let's consider a scenario where we want to monitor CPU usage on a Linux server using Prometheus.

#### Install and Configure `node_exporter`

The `node_exporter` is a popular exporter for collecting system metrics. We would install it on the server we want to monitor.

```bash
# Example installation on Debian/Ubuntu
sudo apt-get update
sudo apt-get install prometheus-node-exporter
```

#### Configure Prometheus to Scrape `node_exporter`

We need to tell Prometheus where to find the `node_exporter`. This is done by adding a job to the `scrape_configs` section of the Prometheus configuration file (`prometheus.yml`).

```yaml
scrape_configs:
  - job_name: 'node'
    static_configs:
      - targets: ['<server_ip>:9100'] # Replace <server_ip> with the server's IP address
```

#### Query CPU Usage in Prometheus

Once Prometheus is scraping the `node_exporter`, we can use PromQL to query CPU usage metrics. For example, to get the average CPU usage over the last 5 minutes, we could use the following query:

```promql
avg(rate(node_cpu_seconds_total{mode!="idle"}[5m])) * 100
```

* `node_cpu_seconds_total`: This metric represents the total number of CPU seconds spent in each mode (idle, user, system, etc.).
* `{mode!="idle"}`: This filters the metric to exclude idle CPU time.
* `rate(node_cpu_seconds_total{mode!="idle"}[5m])`: This calculates the per-second rate of change of the CPU time over the last 5 minutes.
* `avg(...)`: This calculates the average CPU usage across all CPU cores.
* `* 100`: This converts the result to a percentage.

### Exercise: Monitoring Disk Space

* Using the `node_exporter`, identify the metric that provides information about disk space usage.
* Write a PromQL query to calculate the percentage of disk space used on the root partition (`/`).
* Configure Prometheus to scrape a second server and modify your query to display disk space usage for both servers.

## Introduction to Grafana

Grafana is a leading open-source data visualization and monitoring platform. It allows you to create dashboards to visualize metrics from various data sources, including Prometheus.

### Core Concepts of Grafana

* **Data Sources**: Grafana supports a wide range of data sources, including Prometheus, Graphite, InfluxDB, Elasticsearch, and many others. You configure data sources to connect Grafana to your monitoring data.
* **Dashboards**: Dashboards are collections of panels that visualize data. You can create dashboards to monitor specific applications, services, or infrastructure components.
* **Panels**: Panels are individual visualizations within a dashboard. Grafana supports various panel types, including graphs, gauges, tables, and single stat panels.
* **Queries**: Each panel uses a query to fetch data from a data source. The query language depends on the data source (e.g., PromQL for Prometheus).
* **Variables**: Variables allow you to create dynamic dashboards that can be customized based on user input. For example, you can create a variable to select a specific server or application to monitor.
* **Alerting**: Grafana allows you to define alerts based on metric thresholds. When a threshold is breached, Grafana can send notifications to various channels (e.g., email, Slack, PagerDuty).

### Grafana Architecture

Grafana has a relatively simple architecture:

* **Grafana Server**: The core component that handles user authentication, dashboard management, data source connections, and rendering visualizations.
* **Data Sources**: External systems that provide the data to be visualized.
* **Plugins**: Grafana supports plugins to extend its functionality. Plugins can provide new data sources, panel types, or alerting integrations.

### Example: Creating a Grafana Dashboard for CPU Usage

Let's create a simple Grafana dashboard to visualize CPU usage data from Prometheus.

1. **Add Prometheus as a Data Source**: In Grafana, navigate to "Configuration" -> "Data Sources" and add a new data source of type "Prometheus". Configure the URL to point to your Prometheus server.
2. **Create a New Dashboard**: Click on the "+" icon in the Grafana sidebar and select "Dashboard".
3. **Add a Graph Panel**: Click on "Add new panel" and select the "Graph" panel type.
4. **Configure the Panel Query**: In the panel editor, select your Prometheus data source. Enter the following PromQL query to display CPU usage:

```promql
avg(rate(node_cpu_seconds_total{mode!="idle"}[5m])) * 100
```

5. **Customize the Panel**: You can customize the panel's appearance by setting the title, axis labels, colors, and other options.
6. **Save the Dashboard**: Click on the "Save" icon to save your dashboard.

### Exercise: Creating a Dashboard for Memory Usage

* Identify the Prometheus metric that provides information about memory usage.
* Create a new Grafana dashboard to visualize memory usage.
* Add a graph panel to display the total memory, used memory, and free memory.
* Add a single stat panel to display the percentage of memory used.

## Prometheus and Grafana Integration

Prometheus and Grafana are often used together as a powerful monitoring solution. Prometheus collects and stores the time-series data, while Grafana provides a user-friendly interface for visualizing and analyzing that data. Grafana's ability to query Prometheus using PromQL makes it easy to create dashboards that provide insights into the performance of your applications and infrastructure.

### Benefits of Using Prometheus and Grafana Together

* **Comprehensive Monitoring**: Prometheus and Grafana provide a complete monitoring solution, from data collection to visualization and alerting.
* **Scalability**: Both Prometheus and Grafana are designed to scale to handle large amounts of data.
* **Flexibility**: Prometheus and Grafana are highly configurable and can be adapted to monitor a wide range of applications and infrastructure.
* **Open Source**: Both tools are open source, which means they are free to use and can be customized to meet your specific needs.
* **Community Support**: Both Prometheus and Grafana have large and active communities, providing ample resources and support.

## Real-World Application

Consider ExampleCorp, which is migrating its monolithic application to a microservices architecture. They need a robust monitoring solution to ensure the health and performance of their new microservices. They choose Prometheus and Grafana because:

* **Dynamic Environment**: Prometheus's service discovery integrates well with their Kubernetes-based microservices deployment. As new microservices are deployed, Prometheus automatically discovers and monitors them.
* **Granular Metrics**: They can use Prometheus exporters to collect detailed metrics from each microservice, such as request latency, error rates, and resource utilization.
* **Custom Dashboards**: They can create Grafana dashboards to visualize the performance of each microservice, as well as the overall system health.
* **Alerting**: They can configure Grafana alerts to notify them of any performance issues, such as high latency or error rates.

By using Prometheus and Grafana, ExampleCorp can proactively identify and resolve issues, optimize the performance of their microservices, and ensure a positive user experience.

## Summary and Next Steps

In this lesson, we introduced Prometheus and Grafana, two powerful open-source monitoring tools. We explored their core concepts, architectures, and how they work together to provide comprehensive monitoring capabilities. We also looked at practical examples of how to use Prometheus and Grafana to monitor CPU and memory usage.

In the next lesson, we will delve into logging fundamentals and explore centralized logging solutions, which complement metrics-based monitoring by providing detailed information about application behavior. We will also discuss how to integrate logging with Prometheus and Grafana to create a holistic monitoring solution.
